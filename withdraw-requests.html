<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Withdraw Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    header h2 { margin: 0; font-size: 1.5rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td {
      padding: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      text-align: left;
    }
    th { background: rgba(0,0,0,0.2); }
    tr:hover { background: rgba(255,255,255,0.1); }
    button {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 5px;
      font-size: 0.9rem;
      cursor: pointer;
      color: #fff;
    }
    .approve { background-color: #4caf50; }
    .reject { background-color: #f44336; }
    .status { font-weight: bold; }
  </style>
</head>
<body>
  <header>
    <h2>Admin - Withdraw Requests</h2>
    <button onclick="window.location.href='home.html'" style="background:#ffc107; color:#000; padding:0.5rem 1rem; border:none; border-radius:5px; cursor:pointer;">üè† Home</button>
  </header>

  <main style="flex:1; padding: 1rem 2rem;">
    <table id="withdrawTable">
      <thead>
        <tr>
          <th>User</th>
          <th>Phone</th>
          <th>Network</th>
          <th>Wallet</th>
          <th>Amount</th>
          <th>Fee</th>
          <th>Total Deducted</th>
          <th>Status</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script>
    function loadWithdrawals() {
      const withdrawals = JSON.parse(localStorage.getItem("withdrawals")) || [];
      const users = JSON.parse(localStorage.getItem("users")) || [];
      const tableBody = document.querySelector("#withdrawTable tbody");
      tableBody.innerHTML = "";

      withdrawals.forEach((w, index) => {
        const user = users.find(u => u.phone === w.user);
        const name = user ? user.name : "Unknown";
        const status = w.status || "Pending";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${name}</td>
          <td>${w.user}</td>
          <td>${w.network}</td>
          <td>${w.wallet}</td>
          <td>${parseFloat(w.amount).toFixed(2)}</td>
          <td>${parseFloat(w.fee).toFixed(2)}</td>
          <td>${(parseFloat(w.amount) + parseFloat(w.fee)).toFixed(2)}</td>
          <td class="status">${status}</td>
          <td>${w.date}</td>
          <td>
            ${status === "Pending" ? `
              <button class="approve" onclick="updateStatus(${index}, 'Approved')">Approve</button>
              <button class="reject" onclick="updateStatus(${index}, 'Rejected')">Reject</button>
            ` : status}
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function updateStatus(index, status) {
      const withdrawals = JSON.parse(localStorage.getItem("withdrawals")) || [];
      const users = JSON.parse(localStorage.getItem("users")) || [];

      if (status === "Approved") {
        const w = withdrawals[index];
        const phone = w.user;
        const total = parseFloat(w.amount) + parseFloat(w.fee);

        const userIndex = users.findIndex(u => u.phone === phone);
        if (userIndex !== -1) {
          if (!users[userIndex].deposit) users[userIndex].deposit = 0;

          if (users[userIndex].deposit >= total) {
            users[userIndex].deposit -= total;
            withdrawals[index].status = "Approved";
          } else {
            alert("User balance is insufficient for this withdrawal!");
            return;
          }
        } else {
          alert("User not found!");
          return;
        }
      } else {
        withdrawals[index].status = status;
      }

      localStorage.setItem("users", JSON.stringify(users));
      localStorage.setItem("withdrawals", JSON.stringify(withdrawals));
      loadWithdrawals();
      alert(`Withdrawal ${status}`);
    }

    loadWithdrawals();
  </script>
</body>
</html>